#!/bin/bash
# Pre-push hook: run tests before pushing to main

# Read the remote and URL
remote="$1"
url="$2"

# Check if we're pushing to main
while read local_ref local_sha remote_ref remote_sha; do
    if echo "$remote_ref" | grep -q "refs/heads/main"; then
        echo "Pushing to main â€” running tests first..."
        # Use venv's Python directly, clearing conda env vars to avoid conflicts
        REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
        if [ -f "$REPO_DIR/venv/bin/python" ]; then
            unset CONDA_PREFIX CONDA_DEFAULT_ENV CONDA_SHLVL PYTHONPATH
            "$REPO_DIR/venv/bin/python" -m pytest --tb=short -q
        else
            pytest --tb=short -q
        fi
        if [ $? -ne 0 ]; then
            echo ""
            echo "Tests failed. Push to main aborted."
            exit 1
        fi
        echo "All tests passed."
    fi
done

exit 0
